"use strict";function rcube_elastic_ui(){var ref=this,mode="normal",touch=false,ios=false,is_framed=rcmail.is_framed(),env={config:{standard_windows:rcmail.env.standard_windows,message_extwin:rcmail.env.message_extwin,compose_extwin:rcmail.env.compose_extwin,help_open_extwin:rcmail.env.help_open_extwin},small_screen_config:{standard_windows:true,message_extwin:false,compose_extwin:false,help_open_extwin:false}},menus={},content_buttons=[],frame_buttons=[],layout={menu:$("#layout > .menu"),sidebar:$("#layout > .sidebar"),list:$("#layout > .list"),content:$("#layout > .content")},buttons={menu:$("a.menu-button"),back_sidebar:$("a.back-sidebar-button"),back_list:$("a.back-list-button"),back_content:$("a.back-content-button")};this.register_content_buttons=register_content_buttons;this.menu_hide=menu_hide;this.menu_toggle=menu_toggle;this.menu_destroy=menu_destroy;this.popup_init=popup_init;this.about_dialog=about_dialog;this.headers_dialog=headers_dialog;this.import_dialog=import_dialog;this.headers_show=headers_show;this.spellmenu=spellmenu;this.searchmenu=searchmenu;this.headersmenu=headersmenu;this.header_reset=header_reset;this.compose_status=compose_status;this.attachmentmenu=attachmentmenu;this.mailtomenu=mailtomenu;this.recipient_selector=recipient_selector;this.show_list=show_list;this.show_sidebar=show_sidebar;this.smart_field_init=smart_field_init;this.smart_field_reset=smart_field_reset;this.form_errors=form_errors;this.switch_nav_list=switch_nav_list;this.searchbar_init=searchbar_init;this.pretty_checkbox=pretty_checkbox;this.pretty_select=pretty_select;this.datepicker_init=datepicker_init;this.bootstrap_style=bootstrap_style;screen_mode();layout_init();bootstrap_style();toolbar_init();content_frame_init();dropdowns_init();setup();resize();function setup(){var title,form,content_buttons=[];$.ui&&$.widget("ui.dialog",$.ui.dialog,{open:function(){if($(this.element).is(".iframe")){this.options.width=Math.max(576,this.options.width)}this._super();dialog_open(this);return this},close:function(){this._super();$(".select-menu:visible").remove();return this}});buttons.menu.on("click",function(){app_menu(true);return false});buttons.back_sidebar.on("click",function(){show_sidebar();return false});buttons.back_list.on("click",function(){show_list();return false});buttons.back_content.on("click",function(){show_content(true);return false});$(".searchbar").each(function(){searchbar_init(this)});if(is_framed&&!rcmail.env.extwin&&!parent.$(".ui-dialog:visible").length){if(title=$("h1.voice:first").text()){parent.$("#layout > .content > .header > .header-title:not(.constant)").text(title)}}else if(!is_framed){title=$(".boxtitle:first",layout.content).detach().text();if(!title){title=$("h1.voice:first").text()}if(title){$(".header > .header-title",layout.content).text(title)}}if(!is_framed&&layout.content.length&&!$(layout.content).is(".no-navbar")&&!$(layout.content).children(".frame-content").length){env.frame_nav=$('<div class="footer toolbar content-frame-navigation hide-nav-buttons">').append($('<a class="button prev">').append($('<span class="inner"></span>').text(rcmail.gettext("previous")))).append($('<span class="buttons">')).append($('<a class="button next">').append($('<span class="inner"></span>').text(rcmail.gettext("next")))).appendTo(layout.content)}$("a[data-content-button]").each(function(){content_buttons.push(create_cloned_button($(this)))});$(".formbuttons").filter(function(){return!$(this).parent(".searchoptions").length}).children().each(function(){var target=$(this);if(!is_framed&&!target.parents(".content").length){return}if(target.is(".cancel")){target.addClass("hidden");return}content_buttons.push(create_cloned_button(target))});(is_framed?parent.UI:ref).register_content_buttons(content_buttons);if(form=rcmail.gui_objects.messageform){form=$('form[name="'+form+'"]');$("#_cc, #_bcc, #_replyto, #_followupto",$(".compose-headers")).each(function(){$(this).on("change",function(){$("#compose"+$(this).attr("id"))[this.value?"removeClass":"addClass"]("hidden")})});$("#compose-options").find("textarea,input,select").each(function(){var hidden=$("<input>").attr({type:"hidden",name:$(this).attr("name")}).appendTo(form);$(this).attr("tabindex",2).on("change",function(){hidden.val(this.type!="checkbox"||this.checked?$(this).val():"")}).change()})}$("[data-recipient-input]").each(function(){recipient_input(this)});$(".image-upload").each(function(){image_upload_input(this)});$("textarea[data-html-editor]").each(function(){html_editor_init(this)});$("#dragmessage-menu,#dragcontact-menu").each(function(){rcmail.gui_object("dragmenu",this.id)});$("#taskmenu > a").each(function(){if(/button-([a-z]+)/.test(this.className)){var data,name=RegExp.$1,button=find_button(this.id);if(button&&(data=button.data)){if(data.sel){data.sel+=" button "+name;data.sel=data.sel.replace("button-selected","selected")}if(data.act){data.act+=" button "+name}rcmail.buttons[button.command][button.index]=data;rcmail.init_button(button.command,data)}$(this).addClass("button "+name);$(".button-inner",this).addClass("inner")}$(this).on("mouseover",function(){rcube_webmail.long_subject_title(this,0,$("span.inner",this))})});$(".listbutton").each(function(){var button=find_button(this.id);$(this).addClass("button").removeClass("listbutton");if(button.data.sel){button.data.sel=button.data.sel.replace("listbutton","button")}if(button.data.act){button.data.act=button.data.act.replace("listbutton","button")}rcmail.buttons[button.command][button.index]=button.data;rcmail.init_button(button.command,button.data)});$("[data-hidden]").each(function(){var m,v=$(this).data("hidden"),parent=$(this).parent("li"),re=/(large|big|small|phone|lbs)/g;while(m=re.exec(v)){$(parent.length?parent:this).addClass("hidden-"+m[1])}});$("[data-list]").each(function(){$("input[type=checkbox]",this).each(function(){pretty_checkbox(this)})});if(is_framed){$(".formcontent").each(function(){if($(this).next(".formbuttons").length){$(this).parent().addClass("formcontainer")}})}$("#attachment-list + a.zipdownload").appendTo(".header-links");if(ios=$("html").is(".ipad,.iphone")){$(".iframe-wrapper, .scroller").addClass("ios-scroll")}if($("html").filter(".ipad,.iphone,.webkit.mobile,.webkit.tablet").addClass("webkit-scroller").length){$(layout.menu).addClass("webkit-scroller")}$(".treelist").each(function(){var list=this,callback=function(){$(list)[$(".treetoggle",list).length>0?"removeClass":"addClass"]("notree")};if(window.MutationObserver){new MutationObserver(callback).observe(list,{childList:true,subtree:true})}callback()});if(!$("#logo").data("src-default")){$("#logo").data("src-default",$("#logo").attr("src"))}}function register_content_buttons(buttons){if(env.frame_nav&&buttons&&buttons.length){var toolbar=env.frame_nav.children(".buttons");content_buttons=[];$.each(buttons,function(){if(this.data("target")){content_buttons.push(this.data("target"))}});toolbar.html("").append(buttons)}}function register_cloned_button(old_id,new_id,active_class){var button=find_button(old_id);if(button){rcmail.register_button(button.command,new_id,button.data.type,active_class,button.data.sel)}}function create_cloned_button(target,menu_button,add_class,always_active){var popup,click=true,button=$("<a>"),target_id=target.attr("id")||(new Date).getTime(),button_id=target_id+"-clone",btn_class=target[0].className+(add_class?" "+add_class:"");if(!menu_button){btn_class=$.trim(btn_class.replace("btn-primary","primary").replace(/(btn[a-z-]*|button|disabled)/g,""));btn_class+=" button"+(!always_active?" disabled":"")}else if(popup=target.data("popup")){button.data({popup:popup,"toggle-button":target.data("toggle-button")});popup_init(button[0]);click=false;rcmail.register_menu_button(button[0],popup)}button.attr({id:button_id,href:"#",class:btn_class}).append($('<span class="inner">').text(target.text()));if(click){button.on("click",function(e){target.click()})}if(is_framed&&!menu_button){button.data("target",target);frame_buttons.push($.extend({button_id:button_id},find_button(target[0].id)))}else{register_cloned_button(target_id,button_id,btn_class.replace(" disabled",""))}return button}function find_button(id){var i,button,command;for(command in rcmail.buttons){for(i=0;i<rcmail.buttons[command].length;i++){button=rcmail.buttons[command][i];if(button.id==id){return{command:command,index:i,data:button}}}}}function layout_init(){env.last_selected=$("#layout > div.selected")[0];if(!env.last_selected&&layout.content.length){$.each(["sidebar","list","content"],function(){if(layout[this].length){env.last_selected=layout[this][0];layout[this].addClass("selected");return false}})}$(window).on("resize",function(){clearTimeout(env.resize_timeout);env.resize_timeout=setTimeout(function(){resize()},25)});env.open_window=rcmail.open_window;rcmail.open_window=window_open;rcmail.addEventListener("message",message_displayed).addEventListener("menu-open",menu_toggle).addEventListener("menu-close",menu_toggle).addEventListener("editor-init",tinymce_init).addEventListener("autocomplete_create",rcmail_popup_init).addEventListener("googiespell_create",rcmail_popup_init).addEventListener("setquota",update_quota).addEventListener("enable-command",enable_command_handler).addEventListener("init",init);if(window.MutationObserver&&window.tinymce){var callback=function(list){$.each(list,function(){$.each(this.addedNodes,function(){tinymce_style(this)})})};new MutationObserver(callback).observe(document.body,{childList:true})}}function init(){$("table[data-list]").each(function(){var button,table=$(this),list=table.data("list");if(rcmail[list]&&rcmail[list].multiselect){var repl,button,parent=table.parents(".sidebar,.list,.content").last(),header=parent.find(".header"),toolbar=header.find("ul");if(!toolbar.length){toolbar=header}else if(button=toolbar.find("a.button.select").data("toggle-button")){button=$("#"+button)}rcmail[list].enable_checkbox_selection();if(!button){button=$("<a>").attr({class:"button select disabled",role:"button",title:rcmail.gettext("select")}).on("click",function(){if($(this).is(".active"))table.toggleClass("withselection")}).append($('<span class="inner">').text(rcmail.gettext("select")));if(toolbar.is(".toolbar")||toolbar.is(".toolbarmenu")){button.prependTo(toolbar).wrap('<li role="menuitem">');if(layout.content){var button2=create_cloned_button(button,true,"hidden-big hidden-large");$('<li role="menuitem">').append(button2).appendTo("#toolbar-menu");button=button.add(button2)}}else{if(repl=table.data("list-select-replace")){$(repl).replaceWith(button)}else{button.appendTo(toolbar).addClass("icon");if(!parent.is(".sidebar")){button.addClass("toolbar-button")}}}}rcmail.addEventListener("listupdate",function(prop){if(prop.list&&prop.list==rcmail[list]){if(prop.rowcount){button.addClass("active").removeClass("disabled").attr("tabindex",0)}else{button.removeClass("active").addClass("disabled").attr("tabindex",-1)}}})}if(touch&&rcmail[list]){if(typeof rcmail[list].draggable=="function"){rcmail[list].draggable("destroy")}else if(typeof rcmail[list].draggable=="boolean"){rcmail[list].draggable=false}}});if(window.MutationObserver){$("[data-label-msg]").filter("ul,table").each(function(){var fn,observer,callback,info=$('<div class="listing-info hidden">').insertAfter(this),table=$(this),fn=function(){var ext,command,msg=table.data("label-msg"),list=table.is("ul")?table:table.children("tbody");if(!rcmail.env.search_request&&!rcmail.env.qsearch&&msg&&!list.children(":visible").length){ext=table.data("label-ext");command=table.data("create-command");if(ext&&(!command||rcmail.commands[command])){msg+=" "+ext}info.text(msg).removeClass("hidden");return}info.addClass("hidden")};callback=function(){if(rcmail.busy||!table.is(":visible")){return setTimeout(callback,250)}clearTimeout(env.list_timer);env.list_timer=setTimeout(fn,50)};observer=new MutationObserver(callback);observer.observe(table[0],{childList:true,subtree:true,attributes:true,attributeFilter:["style"]});callback()})}if((layout.list.length||layout.content.length)&&is_mobile()){var fabuttons=[];$("[data-fab]").each(function(){var button=$(this),task=button.data("fab-task")||"*",action=button.data("fab-action")||"*";if((task=="*"||task==rcmail.task)&&(action=="*"||action==rcmail.env.action||action=="none"&&!rcmail.env.action)){fabuttons.push(create_cloned_button(button,false,false,true))}});if(fabuttons.length){$('<div class="floating-action-buttons">').append(fabuttons).appendTo(layout.list.length?layout.list:layout.content)}}if(rcmail.env.action!="print"){$("#attachment-list > li").each(function(){attachmentmenu_append(this)})}var phone_confirmation=function(label){if(mode=="phone"){rcmail.display_message(rcmail.gettext(label),"confirmation")}};rcmail.addEventListener("fileappended",function(e){if(e.attachment.complete){attachmentmenu_append(e.item);if(e.attachment.mimetype=="text/vcard"&&rcmail.commands["attach-vcard"]){phone_confirmation("vcard_attachments.vcardattached")}}}).addEventListener("managesieve.insertrow",function(o){bootstrap_style(o.obj)}).addEventListener("add-recipient",function(){phone_confirmation("recipientsadded")});rcmail.init_pagejumper(".pagenav > input");if(rcmail.task=="mail"){if(rcmail.env.action=="compose"){if(!rcmail.env.extwin){$("a.button.mail",layout.menu).attr("onclick","return rcmail.command('list','',this,event)")}rcmail.addEventListener("compose-encrypted",function(e){$("a.mode-html, button.attach").prop("disabled",e.active);$("a.button.attach, a.button.responses")[e.active?"addClass":"removeClass"]("disabled")});$(".sidebar > .footer:not(.pagenav) > a.button").click(function(){if($(this).is(".disabled")){rcmail.display_message(rcmail.gettext("nocontactselected"),"warning")}});if(window.MutationObserver){var observer,list=$("#attachment-list"),status_callback=function(){compose_status("attach",list.children().length>0)};observer=new MutationObserver(status_callback);observer.observe(list[0],{childList:true});status_callback()}}if(rcmail.env.action=="preview"||rcmail.env.action=="show"){$("a").filter('[href^="mailto:"]').each(function(){mailtomenu_append(this)})}}else if(rcmail.task=="settings"){rcmail.addEventListener("identity-encryption-show",function(p){bootstrap_style(p.container)});rcmail.addEventListener("identity-encryption-update",function(p){bootstrap_style(p.container)})}rcmail.set_env({thread_padding:"1.5rem",popup_width_small:1025,popup_width:1200});if(rcmail.env.devel_mode&&window.less){less.pageLoadFinished.then(function(){resize()})}else{resize()}var func,format=rcmail.env.date_format_localized;if(format){func=function(input){$(input).filter(".datepicker").attr("placeholder",format)};$("input.datepicker").each(function(){func(this)});rcmail.addEventListener("insert-edit-field",func)}}function bootstrap_style(context){if(!context){context=document}$("input.button,button",context).not(".btn").addClass("btn").not(".btn-primary,.primary,.mainaction").addClass("btn-secondary");$("input.button.mainaction,button.primary,button.mainaction",context).addClass("btn-primary");$("button.btn.delete,button.btn.discard",context).addClass("btn-danger");$.each(["warning","error","information","confirmation"],function(){var type=this;$(".box"+type+":not(.ui.alert)",context).each(function(){alert_style(this,type,true)})});if(context!=document&&$(".popup",context).children().length==1){var content=$(".popup",context).children().first();if(content.is("img")){$(".popup",context).addClass("justified")}else if(content.is("label")){var input=content.find("input").detach(),label=content.detach(),id=input.attr("id");if(!id){input.attr("id",id="dialog-input-elastic")}$(".popup",context).addClass("formcontent").append($('<div class="form-group row">').append(label.attr("for",id).addClass("col-sm-2 col-form-label")).append($('<div class="col-sm-10">').append(input)));input.focus()}}var supported_controls="input:not(.button,.no-bs,[type=button],[type=file],[type=radio],[type=checkbox]),textarea";$(supported_controls,$(".propform",context)).addClass("form-control");$("[type=checkbox]",$(".propform",context)).addClass("form-check-input");$("select",context).addClass("form-control custom-select");if(context!=document){$(supported_controls,context).addClass("form-control")}$("table.propform",context).each(function(){var text_rows=0,form_rows=0;$(this).find("> tbody > tr").each(function(){var first,last,row=$(this),row_classes=["form-group","row"],cells=row.children("td");if(cells.length==2){first=cells.first();last=cells.last();$("label",first).addClass("col-form-label");first.addClass("col-sm-4");last.addClass("col-sm-8");if(last.find("[type=checkbox]").length==1&&!last.find(".proplist").length){row_classes.push("form-check");if(last.find("a").length){row_classes.push("with-link")}form_rows++}else if(!last.find("input:not([type=hidden]),textarea,radio,select").length){last.addClass("form-control-plaintext");text_rows++}else{form_rows++}if(last.children(".datepicker")&&last.children("input").length==2){last.addClass("datetime")}}else if(cells.length==1){cells.css("width","100%")}row.addClass(row_classes.join(" "))});if(text_rows>form_rows){$(this).addClass("text-only")}});$("td.input-group",context).each(function(){$(this).children(":not(:first)").addClass("input-group-append")});$("fieldset.propform:not(.groupped) div.row",context).each(function(){var has_input=$("input:not([type=hidden]),select,textarea",this).length>0;if(has_input){$(supported_controls,this).addClass("form-control")}$(this).children().last().addClass("col-sm-8"+(!has_input?" form-control-plaintext":""));$(this).children().first().addClass("col-sm-4 col-form-label");$(this).addClass("form-group")});$("fieldset.propform.groupped fieldset",context).each(function(){$(".row",this).each(function(){var label,first,has_input=$("input,select,textarea",this).length>0,items=$(this).children();if(has_input){$(supported_controls,this).addClass("form-control")}if(items.length<2){return}first=items.first();if(first.is("select")){first.addClass("input-group-prepend")}else{first.wrap('<span class="input-group-prepend">').addClass("input-group-text")}if(!has_input){items.last().addClass("form-control-plaintext")}$(".content",this).addClass("input-group-prepend input-group-append input-group-text");$("a.deletebutton",this).addClass("input-group-text icon delete").wrap('<span class="input-group-append">');$(this).addClass("input-group")})});$(".propform > .prop.block:not(.row)",context).each(function(){$(this).addClass("form-group row").each(function(){$("label",this).addClass("col-form-label").wrap($('<div class="col-sm-4">'));$("input,select,textarea",this).wrap($('<div class="col-sm-8">'));$(supported_controls,this).addClass("form-control")})});$("td.rowbuttons > a",context).addClass("btn");$("form.tabbed,div.tabbed",context).each(function(idx,item){var tabs=[],nav=$("<ul>").attr({class:"nav nav-tabs",role:"tablist"});$(this).addClass("tab-content").children("fieldset").each(function(i,fieldset){var tab,id=fieldset.id||"tab"+idx+"-"+i,tab_class=$(fieldset).data("navlink-class");$(fieldset).addClass("tab-pane").attr({id:id,role:"tabpanel"});tab=$("<li>").addClass("nav-item").append($("<a>").addClass("nav-link"+(tab_class?" "+tab_class:"")).attr({role:"tab",href:"#"+id}).text($("legend:first",fieldset).text()).click(function(){$(this).tab("show");return false}));$("legend:first",fieldset).hide();tabs.push(tab)});nav.append(tabs).insertBefore(item);$("a.nav-link:first",nav).click()});$("table:not(.table,.propform,.listing,.ui-datepicker-calendar)",context).filter(function(){return!$(this).parent().is(".propform")&&!$(this).parents(".message-htmlpart,.message-partheaders,.boxinformation,.raw-tables").length}).each(function(){var table=$(this).addClass("table");table.parent().addClass("table-responsive-sm");table.find("thead").addClass("thead-default")});$("input.pretty-checkbox, .propform input[type=checkbox], .form-check > input, .popupmenu.form input[type=checkbox], .toolbarmenu input[type=checkbox]",context).each(function(){pretty_checkbox(this)});if($(context).is(".actionrow")){$("input[type=checkbox]",context).each(function(){pretty_checkbox(this)})}$(".input-group-combo > select:first",context).on("change",function(){var select=$(this),fn=function(){select[select.next().is(":visible")?"removeClass":"addClass"]("alone")};setTimeout(fn,50);setTimeout(fn,2e3)}).trigger("change");$("#message-objects",context).children(":not(.ui.alert)").each(function(){var cl=$(this).removeClass("notice").attr("class").split(/\s/)[0]||"warning";alert_style(this,cl);$(this).addClass("box"+cl);$("a",this).addClass("btn btn-primary")});$(".error",context).addClass("is-invalid");if(rcmail.env.task=="login"&&context==document){$("#rcmloginsubmit").addClass("btn-lg text-uppercase w-100");$("#login-form table tr").each(function(){var input=$("input,select",this),label=$("label",this),icon_name=input.data("icon"),icon=$("<i>").attr("class","input-group-text icon "+input.attr("name").replace("_",""));if(icon_name){icon.addClass(icon_name)}$(this).addClass("form-group row");label.parent().css("display","none");input.addClass(input.is("select")?"custom-select":"form-control").attr("placeholder",label.text()).before($('<span class="input-group-prepend">').append(icon)).parent().addClass("input-group input-group-lg")})}$("select:not([multiple])",context).each(function(){pretty_select(this)})}function tinymce_style(elem){if($(elem).is(".mce-window")){var body=$(elem).find(".mce-window-body"),foot=$(elem).find(".mce-foot > .mce-container-body");if(body.length){bootstrap_style(body[0])}body.find("button").filter(function(){return $(this).parent(".mce-btn").length>0}).removeClass("btn btn-secondary");if(foot.children(".mce-widget").length===5){foot.addClass("mce-search-foot")}$(elem).find(".mce-charmap").parent().parent().addClass("mce-charmap-dialog");$(elem).find(".mce-combobox").each(function(){if(!$(this).children(".mce-btn").length){$(this).addClass("mce-combobox-fake")}});$(elem).find(".mce-form > .mce-container-body").each(function(){if($(this).children(".mce-formitem").length>4){$(this).addClass("mce-form-split")}});$(elem).find(".mce-form").next(":not(.mce-formitem)").addClass("mce-form");if(!is_mobile()){var offset,max_height=0,height=body.height();$(elem).find(".mce-form").each(function(){max_height=Math.max(max_height,$(this).height())});if(height<max_height){max_height+=(body.find(".mce-tabs").height()||0)+25;body.height(max_height);$(elem).height($(elem).height()+(max_height-height));$(elem).css("top",($(window).height()-$(elem).height())/2+"px")}}}else if($(elem).is(".mce-menu")){$(elem).prepend($('<h3 class="popover-header">').append($('<a class="button icon "'+"cancel"+'">').text(rcmail.gettext("close")).on("click",function(){$(document.body).click()})));if(window.MutationObserver){var callback=function(){if(mode!="phone"){return}if(!$(".mce-menu:visible").length){$("div.mce-overlay").click()}else if(!$("div.mce-overlay").length){$("<div>").attr("class","popover-overlay mce-overlay").appendTo("body").click(function(){$(this).remove()})}};new MutationObserver(callback).observe(elem,{attributes:true})}}}function dropdowns_init(){$("[data-popup]").each(function(){popup_init(this)});$(document).on("click",popups_close);rcube_webmail.set_iframe_events({mousedown:popups_close,touchstart:popups_close})}function content_frame_init(){var last_selected=env.last_selected,title_reset=function(title){if(typeof title!=="string"||!title.length){title=$("h1.voice").text()||$("title").text()||""}$(".header > .header-title",layout.content).text(title)};var common_content_handler=function(e,href,show,title){if(is_mobile()){content_frame_navigation(href,e)}if(show&&!layout.content.is(":visible")){env.last_selected=layout.content[0];screen_resize();if(title){title_reset(title)}}else if(!show){if(env.last_selected!=last_selected&&!env.content_lock){env.last_selected=last_selected;screen_resize()}title_reset()}env.content_lock=false};var common_list_handler=function(e){if(mode!="large"&&!env.content_lock&&e.force){show_list()}env.content_lock=false;if(e.title){$(".header > .header-title",layout.list).text(e.title)}};var list_handler=function(e){var args={};if(rcmail.env.task=="addressbook"||rcmail.env.task=="mail"){args.force=true}if(rcmail.env.task=="mail"&&!rcmail.env.action){var name=$.type(e)=="string"?e:rcmail.env.mailbox,folder=rcmail.env.mailboxes[name];args.title=folder?folder.name:""}common_list_handler(args)};layout.content.find("iframe").on("load",function(e){var href="",show=true;$(this).parent(".iframe-wrapper").scrollTop(0);try{href=e.target.contentWindow.location.href;show=!href.endsWith(rcmail.env.blankpage);$(e.target.contentWindow).on("unload",title_reset)}catch(e){}common_content_handler(e,href,show)});rcmail.addEventListener("afterlist",list_handler).addEventListener("afterlistgroup",list_handler).addEventListener("afterlistsearch",list_handler).addEventListener("show-list",function(e){e.force=true;common_list_handler(e)}).addEventListener("show-content",function(e){if(!$(e.obj).is("iframe")){$(e.scrollElement||e.obj).scrollTop(0);if(is_mobile()){iframe_loader(e.obj)}}common_content_handler(e.event||new Event,"_action="+(e.mode||"edit"),true,e.title)})}function content_frame_navigation(href,event){if(href.match(/_action=(create|add)/)||href.match(/_nav=hide/)){$(env.frame_nav).addClass("hide-nav-buttons");return}var node,uid,list,_list=$("[data-list]",layout.list).data("list");if(!_list||!(list=rcmail[_list])){if($(env.frame_nav).is(".hide-nav-buttons")&&!$(".buttons",env.frame_nav).children().length){$(env.frame_nav).addClass("hidden")}return}$(env.frame_nav).removeClass("hide-nav-buttons hidden");if(uid=list.get_single_selection()){if(list.rows&&list.rows[uid]&&!list.rows[uid].expanded){list.expand_row(event,uid)}else if(list.get_node&&(node=list.get_node(uid))&&node.collapsed){list.expand(uid)}}var prev,next,frame=$("#"+rcmail.env.contentframe),next_button=$("a.button.next",env.frame_nav).off("click").addClass("disabled"),prev_button=$("a.button.prev",env.frame_nav).off("click").addClass("disabled");if((next=list.get_next())||rcmail.env.current_page<rcmail.env.pagecount){next_button.removeClass("disabled").on("click",function(){env.content_lock=true;iframe_loader(frame);if(next){list.select(next)}else{rcmail.env.list_uid="FIRST";rcmail.command("nextpage")}})}if((prev=list.get_prev())&&(prev!="*"||_list!="subscription_list")||rcmail.env.current_page>1){prev_button.removeClass("disabled").on("click",function(){env.content_lock=true;iframe_loader(frame);if(prev){list.select(prev)}else{rcmail.env.list_uid="LAST";rcmail.command("previouspage")}})}}function tinymce_init(o){o.config.plugins+=" autoresize";if(is_touch()){o.config.toolbar_items_size=null;o.config.toolbar="undo redo | insert | styleselect";if(o.config.plugins.match(/emoticons/)){o.config.toolbar+=" emoticons"}}if(rcmail.task=="mail"&&rcmail.env.action=="compose"){var form=$("#compose-content > form"),keypress=function(e){if(e.key=="Tab"&&e.shiftKey){$("#compose-content > form").scrollTop(0)}};o.config.setup_callback=function(ed){ed.on("keypress",keypress)};$("#composebody").on("keypress",keypress);form.on("scroll",function(){var container=$(".mce-container-body",form),toolbar=$(".mce-top-part",container),editor_offset=container.offset(),header_top=form.offset().top;if(editor_offset&&editor_offset.top-header_top<0){toolbar.css({position:"fixed",top:header_top+"px",width:container.width()+"px"})}else{toolbar.css({position:"relative",top:0,width:"auto"})}});$(window).resize(function(){form.trigger("scroll")})}}function datepicker_init(datepicker){if(window.MutationObserver){$(datepicker).not("[data-observed]").each(function(){var overlay,hidden=true,win=is_framed?parent:window,callback=function(data){$.each(data,function(i,v){if(v.type=="attributes"){var is_hidden=$(v.target).attr("aria-hidden")=="true";if(is_hidden!=hidden){if(!is_hidden){overlay=$("<div>").attr("class","ui-widget-overlay datepicker").appendTo(win.document.body).click(function(e){$(this).remove();if(is_framed){$.datepicker._hideDatepicker()}})}else if(overlay){overlay.remove()}hidden=is_hidden}}else if(v.addedNodes.length){win.UI.bootstrap_style(v.target);if(is_framed){win.$("select.ui-datepicker-month",v.target).on("change",function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"M")});win.$("select.ui-datepicker-year",v.target).on("change",function(){$.datepicker._selectMonthYear($.datepicker._lastInput,this,"Y")})}}})};$(this).attr("data-observed","1");if(is_framed){$(this).detach().appendTo(parent.document.body);$('<div id="ui-datepicker-div" class="hidden">').appendTo(document.body)}new MutationObserver(callback).observe(this,{childList:true,subtree:false,attributes:true,attributeFilter:["aria-hidden"]})})}}function rcmail_popup_init(o){$("table,ul",o.obj).addClass("toolbarmenu listing iconized");$(o.obj).addClass("popupmenu popover");bootstrap_style(o.obj);$("input",o.obj).addClass("form-control");if(is_mobile()&&$(o.obj).is(".googie_window")){var title=rcmail.gettext("close"),class_name="button icon cancel",close_link=$("<a>").attr("class",class_name).text(title).click(function(e){e.stopPropagation();$(".popover-overlay").remove();$(o.obj).hide()});$('<h3 class="popover-header">').append(close_link).prependTo(o.obj);if(!$(".popover-overlay").length){$("<div>").attr("class","popover-overlay").appendTo("body").click(function(){$(this).remove()})}$("table,button",o.obj).click(function(e){if(!$(e.target).is("input")){$(".popover-overlay").remove()}})}}function enable_command_handler(args){if(is_framed){$.each(frame_buttons,function(i,button){if(args.command==button.command){parent.$("#"+button.button_id)[args.status?"removeClass":"addClass"]("disabled")}})}if(rcmail.task=="mail"){switch(args.command){case"reply-list":if(rcmail.env.reply_all_mode==1){var label=rcmail.gettext(args.status?"replylist":"replyall");$("a.button.reply-all").attr("title",label).find(".inner").text(label)}break;case"compose-encrypted":if(args.status){$("a.button.encrypt:not(.icon)").parent().show()}break;case"compose-encrypted-signed":$("#encryption-menu-button").show();break}}}function screen_mode(){var size,width=$(window).width();if(width<=480)size="phone";else if(width>1200)size="large";else if(width>768)size="normal";else size="small";touch=width<=1024;mode=size}function resize(){var mobile;screen_mode();screen_resize();screen_resize_html();if(mobile=is_mobile()){rcmail.set_env(env.small_screen_config);rcmail.enable_command("extwin",false)}else{rcmail.set_env(env.config);rcmail.enable_command("extwin",true)}$.each(content_buttons,function(){$(this)[mobile?"hide":"show"]()})}function screen_resize(){if(is_framed&&!layout.sidebar.length&&!layout.list.length){return}switch(mode){case"phone":screen_resize_phone();break;case"small":screen_resize_small();break;case"normal":screen_resize_normal();break;case"large":screen_resize_large();break}screen_resize_logo(mode);screen_resize_headers();if(bw.webkit){$(".iframe-wrapper").each(function(){var h=$(this).height();if(h){$(this).children("iframe").height(h)}})}}function screen_resize_html(){var meta=layout_metadata(),html=$(document.documentElement);if(html[0].className.match(/layout-([a-z]+)/)){if(RegExp.$1!=meta.mode){html.removeClass("layout-"+RegExp.$1).addClass("layout-"+meta.mode)}}else{html.addClass("layout-"+meta.mode)}if(meta.touch&&!html.is(".touch")){html.addClass("touch")}else if(!meta.touch&&html.is(".touch")){html.removeClass("touch")}}function screen_resize_logo(mode){if(mode=="phone"&&$("#logo").data("src-small")){$("#logo").attr("src",$("#logo").data("src-small"))}else{$("#logo").attr("src",$("#logo").data("src-default"))}}function screen_resize_headers(){$("#layout > div > .header").each(function(){var title,right=0,left=0,padding=0,sizes={left:0,right:0};$(this).children(":visible").each(function(){if(!title&&$(this).is(".header-title")){title=$(this);return}
sizes[title?"right":"left"]+=this.offsetWidth});if(padding+sizes.right>=sizes.left){right=0;left=sizes.right+padding-sizes.left}else{left=0;right=sizes.left-(padding+sizes.right)}$(title).css({"margin-right":right+"px","margin-left":left+"px","padding-right":padding+"px"})})}function screen_resize_phone(){screen_resize_small_all();app_menu(false)}function screen_resize_small(){screen_resize_small_all();app_menu(true)}function screen_resize_normal(){var show;if(layout.list.length){show=layout.list.is(env.last_selected)||!layout.sidebar.is(env.last_selected)&&!layout.sidebar.is(".layout-sticky");layout.list[show?"removeClass":"addClass"]("hidden")}if(layout.sidebar.length){show=!layout.list.length||layout.sidebar.is(env.last_selected)||layout.sidebar.is(".layout-sticky");layout.sidebar[show?"removeClass":"addClass"]("hidden")}layout.content.removeClass("hidden");app_menu(true);screen_resize_small_none();if(layout.list){$(".header > ul.toolbar",layout.list).addClass("popupmenu toolbarmenu").removeClass("toolbar")}}function screen_resize_large(){$.each(layout,function(name,item){item.removeClass("hidden")});screen_resize_small_none();if(layout.list){$(".header > ul.toolbarmenu.popupmenu",layout.list).removeClass("popupmenu toolbarmenu").addClass("toolbar")}}function screen_resize_small_all(){var show,got_content=false;if(layout.content.length){show=got_content=layout.content.is(env.last_selected);layout.content[show?"removeClass":"addClass"]("hidden");$(".header > ul.toolbar",layout.content).addClass("popupmenu")}if(layout.list.length){show=!got_content&&layout.list.is(env.last_selected);layout.list[show?"removeClass":"addClass"]("hidden");$(".header > ul.toolbar",layout.list).addClass("popupmenu")}if(layout.sidebar.length){show=!got_content&&(layout.sidebar.is(env.last_selected)||!layout.list.length);layout.sidebar[show?"removeClass":"addClass"]("hidden")}if(got_content){buttons.back_list.show()}}function screen_resize_small_none(){buttons.back_list.filter(function(){return $(this).parents(".sidebar").length==0}).hide();$("ul.toolbar.popupmenu").removeClass("popupmenu")}function show_content(unsticky){layout.list.addClass("hidden");layout.sidebar.addClass("hidden");layout.content.removeClass("hidden");if(unsticky){layout.sidebar.removeClass("layout-sticky")}screen_resize_headers();env.last_selected=layout.content[0]}function show_sidebar(sticky){layout.list.addClass("hidden");layout.sidebar.removeClass("hidden");if(sticky){layout.sidebar.addClass("layout-sticky")}if(mode=="small"||mode=="phone"){layout.content.addClass("hidden")}screen_resize_headers();env.last_selected=layout.sidebar[0]}function show_list(scroll){if(!layout.list.length&&!layout.sidebar.length){history.back()}else{layout.sidebar.addClass("hidden").removeClass("layout-sticky");layout.list.removeClass("hidden");if(mode=="small"||mode=="phone"){hide_content()}if(scroll){layout.list.children(".scroller").scrollTop(0)}env.last_selected=layout.list[0]}screen_resize_headers()}function hide_content(){env.last_selected=layout.list[0]||layout.sidebar[0];screen_resize();rcmail.show_contentframe(false);$("[data-list]",layout.list).each(function(){var list=$(this).data("list");if(rcmail[list]){if(rcmail[list].clear_selection){rcmail[list].clear_selection()}else if(rcmail[list].select){rcmail[list].select()}}})}function app_menu(show){if(show){if(mode=="phone"){$('<div id="menu-overlay" class="popover-overlay">').on("click",function(){app_menu(false)}).appendTo("body");if(!env.menu_initialized){env.menu_initialized=true;$("a",layout.menu).on("click",function(e){if(mode=="phone")app_menu()})}layout.menu.addClass("popover")}layout.menu.removeClass("hidden")}else{$("#menu-overlay").remove();layout.menu.addClass("hidden").removeClass("popover")}}function message_displayed(p){if(p.type=="loading"&&$(".iframe-loader:visible").length){rcmail.hide_message(p.object);return}alert_style(p.object,p.type,true);$(p.object).attr("role","alert")}function alert_style(object,type,wrap){var tmp,classes="ui alert",addicon=!$(object).is(".noicon"),map={information:"alert-info",notice:"alert-info",confirmation:"alert-success",warning:"alert-warning",error:"alert-danger",loading:"alert-info loading",uploading:"alert-info loading",vcardattachment:"alert-info"};if(wrap&&addicon&&!$(object).is(".aligned-buttons")){$(object).html($("<span>").html($(object).html()))}type=type.split(" ")[0];if(tmp=map[type]){classes+=" "+tmp;if(addicon){$("<i>").attr("class","icon").prependTo(object)}}$(object).addClass(classes)}function dialog_open(dialog){var me=$(dialog.uiDialog),width=me.width(),height=me.height(),maxWidth=$(window).width(),maxHeight=$(window).height();if(maxWidth<=480){me.css({width:"100%",height:"100%"})}else{if(height>maxHeight){me.css("height","100%")}if(width>maxWidth){me.css("width","100%")}}$(document).click();iframe_loader($("div.popup > iframe",me));bootstrap_style(dialog.uiDialog)}function searchbar_init(bar){var options_button=$("a.button.options",bar),input=$("input:not([type=hidden])",bar),placeholder=input.attr("placeholder"),form=$("form",bar),is_search_pending=function(){if(input.val()){return true}if(rcmail.task=="mail"&&$("#s_interval").val()){return true}if(rcmail.gui_objects.search_filter&&$(rcmail.gui_objects.search_filter).val()!="ALL"){return true}if(rcmail.gui_objects.foldersfilter&&$(rcmail.gui_objects.foldersfilter).val()!="---"){return true}},update_func=function(){$(bar)[is_search_pending()?"addClass":"removeClass"]("active")};options_button.on("click",function(e){var id=$(this).data("target"),options=$("#"+id),open=options.is(":visible");if(options.length){if(!open){if(ref[id]){ref[id](options.get(0),this,e)}else if(typeof window[id]=="function"){window[id](options.get(0),this,e)}}options.next()[open?"show":"hide"]();options.toggleClass("hidden");$(".floating-action-buttons").toggleClass("hidden");$(bar).toggleClass("open");$("button.search",options).off("click.search").on("click.search",function(){options_button.trigger("click");update_func()})}});input.on("input change",update_func).on("focus blur",function(e){input.attr("placeholder",e.type=="blur"?placeholder:"")});$("a.reset",bar).on("click",function(e){input.val("").change().trigger("keyup.treelist",{keyCode:27});if($(bar).is(".open")){options_button.click()}if(rcmail.gui_objects.search_filter){$(rcmail.gui_objects.search_filter).val("ALL")}if(rcmail.gui_objects.foldersfilter){$(rcmail.gui_objects.foldersfilter).val("---").change();rcmail.folder_filter("---")}update_func()});rcmail.addEventListener("init",function(){update_func()}).addEventListener("beforelist",function(){if($(bar).is(".open")){options_button.click()}}).addEventListener("responsebeforesearch",function(){update_func()})}function toolbar_init(){if(env.got_smart_toolbar){return}env.got_smart_toolbar=true;var list_mark,items=[],list_items=[],meta=layout_metadata(),button_func=function(button,items,cloned){var item=$('<li role="menuitem">'),button=cloned?create_cloned_button($(button),true,"hidden-big hidden-large"):$(button).detach();button.contents().filter(function(){if(this.nodeType==3&&!$.trim(this.nodeValue).length)$(this).remove()});if(button.is(".spacer")){item.addClass("spacer")}else{item.append(button)}items.push(item)};if(layout.content){$(".header > .toolbar",layout.content).each(function(){var toolbar=$(this);toolbar.children().each(function(){button_func(this,items)});toolbar.remove()})}if(layout.list){$(".header > .toolbar",layout.list).each(function(){var toolbar=$(this);list_mark=toolbar.next();toolbar.children().each(function(){if(meta.mode!="large"){$(this).data("popup-pos","right")}button_func(this,items,true);button_func(this,list_items)});toolbar.remove()})}$('ul[data-menu="toolbar-small"] > li > a').each(function(){var button=$(this).clone();button.attr("id",this.id+"_clone");items.push($('<li role="menuitem">').addClass("hidden-big").append(button))});if(list_items.length){var container=layout.list.children(".header"),menu_attrs={class:"toolbar popupmenu listing iconized",id:"toolbar-list-menu"},menu_button=$('<a class="button icon toolbar-list-button" href="#list-menu">').attr({"data-popup":"toolbar-list-menu"}),toolbar=$("<ul>").attr(menu_attrs).data("popup-parent",container).append(list_items);if(list_mark.length){toolbar.insertBefore(list_mark)}else{container.append(toolbar)}container.append(menu_button)}if(items.length){var container=layout.content.children(".header"),menu_attrs={class:"toolbar popupmenu listing iconized",id:"toolbar-menu"},menu_button=$('<a class="button icon toolbar-menu-button" href="#menu">').attr({"data-popup":"toolbar-menu"});container.append($("<ul>").attr(menu_attrs).data("popup-parent",container).append(items)).append(menu_button);if(layout.list.length){$("a.toolbar-menu-button",layout.list).click(function(e){e.stopPropagation();menu_button.click()})}}}function popup_init(item,win){if(is_framed&&is_mobile()){return parent.UI.popup_init(item,win||window)}if(!win)win=window;var level,popup_id=$(item).data("popup"),popup=$(win.$("#"+popup_id).get(0)),popup_orig=popup,title=$(item).attr("title"),content_element=function(){if(win!=window){popup=popup_orig.clone(true,true);popup.attr("id",popup_id+"-clone").appendTo(document.body).find("li > a, li.checkbox > label").attr("onclick","").off("click").on("click",function(e){if(!$(this).is(".disabled")){$(item).popover("hide");win.$("#"+$(this).attr("id")).click()}return false})}return popup.get(0)};$(item).attr({"aria-haspopup":"true","aria-expanded":"false","aria-owns":popup_id}).popover({content:content_element,trigger:$(item).data("popup-trigger")||"click",placement:$(item).data("popup-pos")||"bottom",animation:true,boundary:"window",html:true}).on("show.bs.popover",function(event){var init_func=popup.data("popup-init");if(popup_id&&menus[popup_id]){menus[popup_id].transitioning=true}if(init_func&&ref[init_func]){ref[init_func](popup.get(0),item,event)}else if(init_func&&win[init_func]){win[init_func](popup.get(0),item,event)}level=$("div.popover:visible").length+1;popup.removeClass("hidden").attr("aria-hidden",false).find('[aria-haspopup="true"]').data("level",level+1).off("click.popup").on("click.popup",function(e){e.stopPropagation()});if(!is_mobile()){popup.css("max-height",Math.min(36*15-1,$(window).height()-30))}}).on("shown.bs.popover",function(event){var mobile=is_mobile(),popover=$("#"+$(item).attr("aria-describedby"));level=$(item).data("level")||1;if(mobile){var label=level>1?"back":"close",title=rcmail.gettext(label),class_name="button icon "+(label=="back"?"back":"cancel");$(".popover-header",popover).empty().append($("<a>").attr("class",class_name).text(title).on("click",function(e){$(item).popover("hide");if(level>1){e.stopPropagation()}}).on("mousedown",function(e){e.stopPropagation()}))}$.each(menus,function(id,prop){if($(prop.target).data("level")==level&&id!=popup_id){menu_hide(id)}});if($(item).data("event")=="key"){popover.off("keydown.popup").on("keydown.popup","a.active",function(e){var entry,node,mode="next";switch(e.which){case 27:case 9:$(item).popover("toggle").focus();return false;case 13:case 32:$(this).trigger("click").data("event","key");return false;case 38:case 63232:mode="previous";case 40:case 63233:entry=e.target.parentNode;while(entry=entry[mode+"Sibling"]){if(node=$(entry).children(".active")[0]){node.focus();break}}return false}});popover.find("a.active:first").focus()}if(popup_id&&menus[popup_id]){menus[popup_id].transitioning=false}if(mobile&&!$(".popover-overlay").length){$("<div>").attr("class","popover-overlay").appendTo("body").click(function(){$(this).remove()})}$(".popover-body",popover).addClass("webkit-scroller")}).on("hide.bs.popover",function(){if(level==1){$(".popover-overlay").remove()}if(popup_id&&menus[popup_id]&&popup.is(":visible")){menus[popup_id].transitioning=true}}).on("hidden.bs.popover",function(){if(/-clone$/.test(popup.attr("id"))){popup.remove()}else{popup.attr("aria-hidden",true).addClass("hidden");popup.appendTo(popup.data("popup-parent")||document.body)}$(".popover-body:empty").each(function(){$(this).parent().remove()});if(popup_id&&menus[popup_id]){delete menus[popup_id]}}).on("click",function(){$(this).data("event","mouse")}).on("keydown",function(e){if(e.originalEvent){switch(e.originalEvent.which){case 13:case 32:e.preventDefault();$(this).data("event","key").popover("toggle");break;case 27:$(this).popover("hide");break}}});if(title){$(item).attr("title",title)}popup.attr("aria-hidden","true").data("button",item);if(popup.data("editable")){popup.on("click mousedown",function(e){e.stopPropagation()})}}function popups_close(e){$(".popover.show").each(function(){var popup=$(".popover-body",this),button=popup.children().first().data("button");if(button&&e.target!=button&&!$(button).find(e.target).length&&typeof button!=="string"){$(button).popover("hide")}if(!button){$(this).remove()}})}function menu_toggle(p){if(!p||!p.name||p.props&&p.props.skinable===false){return}if(is_framed&&is_mobile()){if(!p.win){p.win=window}return parent.UI.menu_toggle(p)}if(p.name=="messagelistmenu"){menu_messagelist(p)}else if(p.event=="menu-open"){var fn,pos,content=$("ul:first",p.obj),target=p.props&&p.props.link?p.props.link:p.originalEvent.target;if($(target).is("span")){target=$(target).parents("a,li")[0]}if(p.name.match(/^drag/)){pos=rcube_event.get_mouse_pos(p.originalEvent);target=$("<a>").css({position:"absolute",left:pos.x,top:pos.y,height:"1px",width:"1px",visibility:"hidden"}).appendTo(document.body).get(0)}pos=$(target).data("popup-pos")||"right";if(p.name=="folder-selector"){content.addClass("listing folderlist")}else if(p.name=="addressbook-selector"||p.name=="contactgroup-selector"){content.addClass("listing contactlist")}else if(content.hasClass("toolbarmenu")){content.addClass("listing")}if(p.name=="pagejump-selector"){content.addClass("simplelist");p.obj.addClass("simplelist");pos="top"}if(menus[p.name]){menu_hide(p.name,p.originalEvent)}fn=function(){if(menus[p.name]&&menus[p.name].transitioning){return setTimeout(fn,50)}if(!$(target).data("popup")){$(target).data({popup:p.name,"popup-pos":pos,"popup-trigger":"manual"});popup_init(target,p.win)}menus[p.name]={target:target};$(target).popover("show")};fn()}else{menu_hide(p.name,p.originalEvent)}p.originalEvent.stopPropagation()}function menu_hide(name,event){var target=menu_target(name);if(name.match(/^drag/)){$(target).popover("dispose").remove()}else{$(target).popover("hide");if(name=="forwardmenu"){popups_close(event)}}}function menu_destroy(name){$("[aria-owns="+name+"]").popover("dispose").data("popup",null)}function menu_target(name){var target;if(menus[name]){target=menus[name].target}else{target=$("#"+name).data("button");if(!target){if(name.match(/(?!-)menu$/)){name=name.substr(0,name.length-4)}target=$("#"+name+"-menu").data("button")}}return target}function menu_messagelist(p){var content=$("#listoptions-menu"),width=content.width()+25,dialog=content.clone(true);$('select[name="sort_col"]',dialog).val(rcmail.env.sort_col||"");$('select[name="sort_ord"]',dialog).val(rcmail.env.sort_order||"ASC");$('select[name="mode"]',dialog).val(rcmail.env.threading?"threads":"list");$("select",dialog).each(function(){this.id=this.id+"-clone"});$("label",dialog).each(function(){$(this).attr("for",$(this).attr("for")+"-clone")});var save_func=function(e){if(rcube_event.is_keyboard(e.originalEvent)){$("#listmenulink").focus()}var col=$('select[name="sort_col"]',dialog).val(),ord=$('select[name="sort_ord"]',dialog).val(),mode=$('select[name="mode"]',dialog).val();rcmail.set_list_options([],col,ord,mode=="threads"?1:0);return true};dialog=rcmail.simple_dialog(dialog,rcmail.gettext("listoptionstitle"),save_func,{closeOnEscape:true,minWidth:400})}function about_dialog(elem){var support_url,support_func,support_button=false,dialog=$("<iframe>").attr({id:"aboutframe",src:rcmail.url("settings/about",{_framed:1})}),support_link=$("#supportlink");if(support_link.length&&(support_url=support_link.attr("href"))){support_button=support_link.text();support_func=function(e){support_url.indexOf("mailto:")<0?window.open(support_url):location.href=support_url}}rcmail.simple_dialog(dialog,$(elem).text(),support_func,{button:support_button,button_class:"help",cancel_button:"close",height:400})}function headers_show(button){var headers=$(button).parent().prev();headers[headers.is(".hidden")?"removeClass":"addClass"]("hidden")}function headers_dialog(){var props={_uid:rcmail.env.uid,_mbox:rcmail.env.mailbox,_framed:1},dialog=$("<iframe>").attr({id:"headersframe",src:rcmail.url("headers",props)});rcmail.simple_dialog(dialog,rcmail.gettext("arialabelmessageheaders"),null,{cancel_button:"close",height:400})}function import_dialog(){if(!rcmail.commands["import-messages"]){return}var content=$("#uploadform"),dialog=content.clone();var save_func=function(e){return rcmail.command("import-messages",$(dialog.find("form")[0]))};rcmail.simple_dialog(dialog,rcmail.gettext("importmessages"),save_func,{button:"import",closeOnEscape:true,minWidth:400})}function searchmenu(obj){var n,all,list=$('input[name="s_mods[]"]',obj),scope_select=$("#s_scope",obj),mbox=rcmail.env.mailbox,mods=rcmail.env.search_mods,scope=rcmail.env.search_scope||"base";if(!$(obj).data("initialized")){$(obj).data("initialized",true);if(list.length){list.on("change",function(){set_searchmod(obj,this)});rcmail.addEventListener("beforesearch",function(){set_searchmod(obj)})}}if(rcmail.env.search_mods){if(rcmail.env.task=="mail"){if(scope=="all"){mbox="*"}mods=mods[mbox]?mods[mbox]:mods["*"];all="text";scope_select.val(scope)}else{all="*"}if(mods[all]){list.map(function(){this.checked=true;this.disabled=this.value!=all})}else{list.prop("disabled",false).prop("checked",false);for(n in mods){list.filter('[value="'+n+'"]').prop("checked",true)}}}}function set_searchmod(menu,elem){var all,m,task=rcmail.env.task,mods=rcmail.env.search_mods,mbox=rcmail.env.mailbox,scope=$("#s_scope",menu).val(),interval=$("#s_interval",menu).val();if(scope=="all"){mbox="*"}if(!mods){mods={}}if(task=="mail"){if(!mods[mbox]){mods[mbox]=rcube_clone_object(mods["*"])}m=mods[mbox];all="text";rcmail.env.search_scope=scope;rcmail.env.search_interval=interval}else{m=mods;all="*"}if(!elem){return}if(!elem.checked){delete m[elem.value]}else{m[elem.value]=1}if(elem.value==all){$('input[name="s_mods[]"]',menu).map(function(){if(this==elem){return}this.checked=true;if(elem.checked){this.disabled=true;delete m[this.value]}else{this.disabled=false;m[this.value]=1}})}rcmail.set_searchmods(m)}function spellmenu(obj){var i,link,li,list=[],lang=rcmail.spellcheck_lang(),ul=$("ul",obj);if(!ul.length){ul=$('<ul class="toolbarmenu selectable listing iconized" role="menu">');for(i in rcmail.env.spell_langs){li=$('<li role="menuitem">');link=$('<a href="#'+i+'" tabindex="0"></a>').text(rcmail.env.spell_langs[i]).addClass("active").data("lang",i).on("click keypress",function(e){if(e.type!="keypress"||rcube_event.get_keycode(e)==13){rcmail.spellcheck_lang_set($(this).data("lang"));rcmail.hide_menu("spell-menu",e);return false}});link.appendTo(li);list.push(li)}ul.append(list).appendTo(obj)}$("li",ul).each(function(){var el=$("a",this);if(el.data("lang")==lang){el.addClass("selected").attr("aria-selected","true")}else if(el.hasClass("selected")){el.removeClass("selected").removeAttr("aria-selected")}})}function compose_status(id,status){var bar=$("#composestatusbar"),ico=bar.find("a.button.icon."+id);if(!status){ico.remove()}else if(!ico.length){$("<a>").attr("class","button icon "+id).on("click",function(){show_sidebar()}).appendTo(bar)}}function attachmentmenu(obj,button,event){var id=$(button).parent().attr("id").replace(/^attach/,"");$.each(["open","download","rename"],function(){var action=this;$("#attachmenu"+action,obj).off("click").attr("onclick","").click(function(e){rcmail.command(action+"-attachment",id,this,e.originalEvent)})});rcmail.command("menu-open",{menu:"attachmentmenu",id:id},obj,event)}function attachmentmenu_append(item){item=$(item);if(!item.is(".no-menu")&&!item.children(".drop").length){var label=rcmail.gettext("options");var button=$("<a>").attr({href:"#",tabindex:0,title:label,class:"button icon dropdown skip-content"}).on("click",function(e){attachmentmenu($("#attachmentmenu"),button,e)}).append($("<span>").attr("class","inner").text(label)).appendTo(item)}}function mailtomenu(obj,button,event){var mailto=$(button).attr("href").replace(/^mailto:/,"");if(mailto.indexOf("@")<0){return true}if(rcmail.env.has_writeable_addressbook){$(".addressbook",obj).addClass("active").off("click").on("click",function(e){var i,contact=mailto,txt=$(button).filter(".rcmContactAddress").text();contact=contact.split("?")[0].split(",")[0].replace(/(^<|>$)/g,"");if(txt){txt=txt.replace("<"+contact+">","");contact='"'+$.trim(txt)+'" <'+contact+">"}rcmail.command("add-contact",contact,this,e.originalEvent)})}$(".compose",obj).off("click").on("click",function(e){rcmail.command("compose",mailto,this,e.originalEvent)});return rcmail.command("menu-open",{menu:"mailto-menu",link:button},button,event)}function mailtomenu_append(item){$(item).attr("onclick","").on("click",function(e){return mailtomenu($("#mailto-menu"),item,e)})}function headersmenu(obj,button,event){$("li > a",obj).each(function(){var link=$(this),target="#compose_"+link.data("target");link[$(target).is(":visible")?"removeClass":"addClass"]("active").off().on("click",function(){$(target).removeClass("hidden").find(".recipient-input input").focus();link.removeClass("active");rcmail.set_menu_buttons()})})}function header_reset(id){$("#"+id).val("").change().closest(".form-group").nextAll(":not(.hidden)").first().find("input").focus();$("a[data-target="+id.replace(/^_/,"")+"]").addClass("active");rcmail.set_menu_buttons()}function recipient_selector(field,opts){if(!opts)opts={};var title=rcmail.gettext(opts.title||"insertcontact"),dialog=$("#recipient-dialog"),parent=dialog.parent(),close_func=function(){if(dialog.is(":visible")){rcmail.env.recipient_dialog.dialog("close")}},insert_func=function(){if(opts.action){opts.action();close_func();return}rcmail.command("add-recipient")};if(!rcmail.env.recipient_selector_initialized){rcmail.addEventListener("add-recipient",close_func);rcmail.env.recipient_selector_initialized=true}if(field){rcmail.env.focused_field="#_"+field}rcmail.contact_list.clear_selection();rcmail.contact_list.multiselect="multiselect"in opts?opts.multiselect:true;rcmail.env.recipient_dialog=rcmail.simple_dialog(dialog,title,insert_func,{button:rcmail.gettext(opts.button||"insert"),button_class:opts.button_class||"insert recipient",height:600,classes:{"ui-dialog-content":"p-0"},open:function(){$("#directorylist a:first").focus()},close:function(){dialog.appendTo(parent);$(this).remove();$(opts.focus||rcmail.env.focused_field).focus()}})}function update_quota(p){var element=$("#quotadisplay"),bar=element.find(".bar"),value=p.total?p.percent:0;if(!bar.length){bar=$('<span class="bar"><span class="value"></span></span>').appendTo(element)}if(value>0&&value<10){value=10}bar.find(".value").css("width",value+"%")[value>=90?"addClass":"removeClass"]("warning");element.attr("title",element.find(".count").attr("title"));if(p.table){element.css("cursor","pointer").data("popup-pos","top").off("click").on("click",function(e){rcmail.simple_dialog(p.table,"quota",null,{cancel_button:"close"})})}else{element.tooltip("dispose").tooltip({trigger:is_mobile()?"click":"hover"})}}function recipient_input(obj){var list,input,ac_props,update_lock,input_len_update=function(){input.css("width",Math.max(40,input.val().length*15+25))},apply_func=function(){$(obj).val(list.text()+input.val())},focus_func=function(){list.addClass("focus")},insert_recipient=function(name,email,replace){var recipient=$('<li class="recipient">'),name_element=$('<span class="name">').html(recipient_input_name(name||email)).on("dblclick",function(e){recipient_input_edit_dialog(e,insert_recipient)}),email_element=$('<span class="email">'),link=$("<a>").attr({class:"button icon remove"}).click(function(){recipient.remove();apply_func();input.focus();return false});if(name){email=" <"+email+">"}email_element.text((name?email:"")+",");recipient.attr("title",name?name+email:null).append([name_element,email_element,link]);if(replace)replace.replaceWith(recipient);else recipient.insertBefore(input.parent())},update_func=function(text){var result;if(update_lock){return}update_lock=true;text=(text||input.val()).replace(/[,;\s]+$/,"");result=recipient_input_parser(text);$.each(result.recipients,function(){insert_recipient(this.name,this.email)});setTimeout(function(){input.val(result.text);apply_func();input_len_update();update_lock=false},1);return result.recipients.length>0},parse_func=function(e){if(e.type=="blur"){list.removeClass("focus")}if(this.value.indexOf("@")<0){return}update_func(e.type=="paste"?(e.originalEvent.clipboardData||window.clipboardData).getData("text"):null)},keydown_func=function(e){if(e.keyCode==8&&!input.val().length){list.children("li.recipient:last").remove();apply_func();return false}else if(e.key==","||e.key==";"||e.key=="Enter"&&!rcmail.ksearch_visible()){if(update_func()){return false}}input_len_update()};input=$("<input>").attr({type:"text",tabindex:$(obj).attr("tabindex")}).on("paste change blur",parse_func).on("keydown",keydown_func).on("focus mousedown",focus_func);list=$("<ul>").addClass("form-control recipient-input").append($("<li>").append(input)).on("click",function(){input.focus()});$(obj).css({position:"absolute",opacity:0,left:"-5000px",width:"10px"}).attr("tabindex",-1).after(list).on("focus",function(e){input.focus()}).on("change",function(e){$("li.recipient",list).remove();input.val(this.value).change()}).change();$(obj).detach().insertBefore(list.parent());if(rcmail.env.autocomplete_threads>0){ac_props={threads:rcmail.env.autocomplete_threads,sources:rcmail.env.autocomplete_sources}}rcmail.init_address_input_events(input,ac_props)}function recipient_input_parser(text){text=$.trim(text.replace(/[,;\s]*[\r\n]+/g,","));var recipients=[],address_rx_part='(\\S+|("[^"]+"))@\\S+',recipient_rx1=new RegExp("(<"+address_rx_part+">)"),recipient_rx2=new RegExp("("+address_rx_part+")"),global_rx=/(?=\S)[^",;]*(?:"[^\\"]*(?:\\[,;\S][^\\"]*)*"[^",;]*)*/g,matches=text.match(global_rx);$.each(matches||[],function(){if(this.length&&(recipient_rx1.test(this)||recipient_rx2.test(this))){var email=RegExp.$1,name=$.trim(this.replace(email,""));recipients.push({name:name,email:email.replace(/(^<|>$)/g,""),text:this});text=text.replace(this,"")}});text=text.replace(/[,;]+/,",").replace(/^[,;\s]+/,"");return{recipients:recipients,text:text}}function recipient_input_name(text){var i,char,result="",len=text.length;if(text.charAt(0)!='"'&&text.indexOf('"')>-1){text='"'+text.replace("\\","\\\\").replace('"','\\"')+'"'}for(i=0;i<len;i++){char=text.charAt(i);switch(char){case'"':if(i>0&&i<len-1){result+='"';break}result+='<span class="quotes">'+char+"</span>";break;case"\\":result+='<span class="quotes">'+char+"</span>";if(text.charAt(i+1)=="\\"){result+=char;i++}break;case"<":result+="&lt;";break;case">":result+="&gt;";break;default:result+=char}}return result}function recipient_input_edit_dialog(e,callback){var element=$(e.target).parents(".recipient"),recipient=element.text().replace(/,+$/,""),input=$("<input>").attr({type:"text",size:50}).val(recipient),content=$("<label>").text(rcmail.gettext("recipient")).append(input);rcmail.simple_dialog(content,"recipientedit",function(){var result,value=input.val();if(value){if(value!=recipient){result=recipient_input_parser(value);if(result.recipients.length!=1){return false}callback(result.recipients[0].name,result.recipients[0].email,element)}return true}})}function image_upload_input(obj){var reset_button=$("<a>").attr({class:"icon button delete",href:"#"}).click(function(e){rcmail.command("delete-photo","",this,e);return false});$(obj).append(reset_button).click(function(){rcmail.upload_input("upload-form")});$("img",obj).on("load",function(){var state=(this.currentSrc||this.src).indexOf(rcmail.env.photo_placeholder)!=-1;$(obj)[state?"removeClass":"addClass"]("changed")})}function iframe_loader(frame){frame=$(frame);if(frame.length){var loader=$("<div>").attr("class","iframe-loader").append($("<div>").attr("class","spinner").text(rcmail.gettext("loading")));frame.on("load error loaded",function(){setTimeout(function(){loader.remove()},500)}).parent().append(loader);if(ios){frame.parent().addClass("ios-scroll")}}}function pretty_checkbox(checkbox){var checkbox=$(checkbox),id=checkbox.attr("id");if(checkbox.is(".icon-checkbox")){return}if(!id){if(!env.icon_checkbox)env.icon_checkbox=0;id="icochk"+ ++env.icon_checkbox;checkbox.attr("id",id)}checkbox.addClass("icon-checkbox form-check-input").after($("<label>").attr({for:id,title:checkbox.attr("title")||""}).on("click",function(e){e.stopPropagation()}))}function pretty_select(select){if(bw.iphone||bw.ipad){return}select=$(select);if(select.is(".pretty-select")){return}var select_ident="select"+select.attr("id")+select.attr("name");var is_menu_open=function(){var win=select[0].ownerDocument.defaultView;if(win.$(".select-menu .listing").data("ident")==select_ident){return true}};var close_func=function(){var open=is_menu_open();select.popover("dispose").focus();return!open};var open_func=function(e){var items=[],dialog=select.closest(".ui-dialog")[0],min_width=select.outerWidth(),max_height=$(document.body).height()-75,max_width=$(document.body).width()-20,value=select.val();if(!is_mobile()){max_height*=.5}$("option",select).each(function(){var label=$(this).text(),link=$('<a href="#">').data("value",this.value).addClass(this.disabled?"disabled":"active"+(this.value==value?" selected":""));if(label.length){link.text(label)}else{link.html("&nbsp;")}items.push($("<li>").append(link))});var list=$('<ul class="toolbarmenu listing selectable iconized">').attr("data-ident",select_ident).append(items).on("click","a.active",function(){var val=$(this).data("value"),ret=close_func();select.val(val).change();return ret}).on("keydown","a.active",function(e){var item,node,mode="next";switch(e.which){case 27:case 9:return close_func();case 13:case 32:$(this).click();return false;case 38:case 63232:mode="previous";case 40:case 63233:item=e.target.parentNode;while(item=item[mode+"Sibling"]){if(node=$(item).children(".active")[0]){node.focus();break}}return false}});select.popover("dispose").popover({container:dialog||document.body,content:list[0],placement:"bottom",trigger:"manual",boundary:"viewport",html:true,offset:"0,2",template:'<div class="popover select-menu" style="min-width: '+min_width+"px; max-width: "+max_width+'px">'+'<div class="popover-header"></div>'+'<div class="popover-body" style="max-height: '+max_height+'px"></div></div>'}).on("shown.bs.popover",function(){list.parent().prev().empty().append($('<a class="button icon cancel">').text(rcmail.gettext("close")).on("click",function(e){e.stopPropagation();return close_func()}));if(rcube_event.is_keyboard(e)){list.find("a.active:first").focus()}list.on("mousedown",function(e){e.stopPropagation()})}).popover("show")};select.addClass("pretty-select custom-select form-control").on("mousedown keydown",function(e){select=$(e.target);if(select.prop("disabled")){return}if(e.which==9){close_func();return true}if(e.which==27||e.type=="mousedown"&&is_menu_open()){return close_func()}select.focus();select.prop("disabled",true);setTimeout(function(){select.prop("disabled",false)},0);e.stopPropagation();if(e.type=="mousedown"||e.which==13||e.which==32||e.which==40||e.which==63233){open_func(e);return false}}).on("click",function(e){e.stopPropagation();return false})}function html_editor_init(obj){var sw,is_table=false,editor=$(obj),parent=editor.parent(),tabindex=editor.attr("tabindex"),mode=function(){if(is_table){return sw.is(":checked")?"html":"plain"}return sw.val()
},tabs=$('<ul class="nav nav-tabs">').append($('<li class="nav-item">').append($('<a class="nav-link mode-html" href="#">').text(rcmail.gettext("htmltoggle")))).append($('<li class="nav-item">').append($('<a class="nav-link mode-plain" href="#">').text(rcmail.gettext("plaintoggle"))));if(parent.is("td")){sw=$('input[type="checkbox"]',parent.parent().next());is_table=true}else{sw=$('[name="editorSelector"]',obj.form)}if(sw.length!=1){return}parent.addClass("html-editor");editor.before(tabs);$("a",tabs).attr("tabindex",tabindex).on("click",function(e){var id=editor.attr("id"),is_html=$(this).is(".mode-html");e.preventDefault();if(rcmail.command("toggle-editor",{id:id,html:is_html},"",e.originalEvent)){$(this).tab("show").prop("tabindex",-1);$(".mode-"+(is_html?"plain":"html"),tabs).prop("tabindex",tabindex);if(is_table){sw.prop("checked",is_html)}}}).filter(".mode-"+mode()).tab("show").prop("tabindex",-1);if(is_table){sw.parent().parent().hide();parent.prev().hide();parent.addClass("col-sm-12")}textarea_autoresize_init(editor)}function textarea_autoresize_init(textarea){var resize=function(e){clearTimeout(env.textarea_timer);env.textarea_timer=setTimeout(function(){var area=$(e.target),initial_height=area.data("initial-height"),scroll_height=area[0].scrollHeight;if(!scroll_height){return}if(!initial_height){area.data("initial-height",initial_height=scroll_height)}if(area.outerHeight()-scroll_height==2){scroll_height-=19}area.outerHeight(Math.max(initial_height,scroll_height))},10)};$(textarea).css("overflow-y","hidden").on("input",resize).trigger("input");setInterval(function(){$(textarea).trigger("input")},1e3)}function smart_field_init(field){var tip,id=field.id+"_list",area=$('<div class="multi-input"><div class="content"></div><div class="invalid-feedback"></div></div>'),list=field.value?field.value.split("\n"):[""];if($("#"+id).length){return}$.each(list,function(i,v){smart_field_row_add($(".content",area),v,field.name,i,$(field).data("size"))});area.attr("id",id);field=$(field);if(field.attr("disabled")){area.hide()}else{field.prop("disabled",true)}if(field.data("hidden")){area.hide()}field.after(area);if(field.hasClass("is-invalid")){area.addClass("is-invalid");$(".invalid-feedback",area).text(field.data("error-msg"))}}function smart_field_row_add(area,value,name,idx,size,after){var input,elem=$('<div class="input-group">'+'<input type="text" class="form-control">'+'<span class="input-group-append"><a class="icon reset input-group-text" href="#"></a></span>'+"</div>"),attrs={value:value,name:name+"[]"};if(size){attrs.size=size}input=$("input",elem).attr(attrs).keydown(function(e){var input=$(this);if(e.which==13){var name=input.attr("name").replace(/\[\]$/,""),dt=(new Date).getTime(),elem=smart_field_row_add(area,"",name,dt,size,input.parent());$("input",elem).focus()}else if((e.which==8||e.which==46)&&input.val()==""){var parent=input.parent(),siblings=area.children();if(siblings.length>1){if(parent.prev().length){parent.prev().children("input").focus()}else{parent.next().children("input").focus()}parent.remove();return false}}});$("a.reset",elem).click(function(){var record=$(this.parentNode.parentNode);if(area.children().length>1){$("input",record.next().length?record.next():record.prev()).focus();record.remove()}else{$("input",record).val("").focus()}});$(elem).find("input,a").on("focus",function(){area.addClass("focused")}).on("blur",function(){area.removeClass("focused")});if(after){after.after(elem)}else{elem.appendTo(area)}return elem}function smart_field_reset(field,data){var id=field.id+"_list",list=data.length?data:[""],area=$("#"+id).children(".content");area.empty();$.each(list,function(i,v){smart_field_row_add(area,v,field.name,i,$(field).data("size"))})}function form_errors(tips){$.each(tips,function(){var input=$("#"+this[0]).addClass("is-invalid");if(input.data("type")=="list"){input.data("error-msg",this[2]);return}input.after($('<span class="invalid-feedback">').text(this[2]))})}function switch_nav_list(obj){var records,height,speed=250,button=$("a.button",obj),navlist=$(obj).next();if(!navlist.height()){records=$("tr,li",navlist).filter(function(){return this.style.display!="none"});height=$(records[0]).height()||50;navlist.animate({height:Math.min(5,records.length)*height+1+"px"},speed);button.addClass("collapse").removeClass("expand");$(obj).addClass("expanded")}else{navlist.animate({height:"0"},speed);button.addClass("expand").removeClass("collapse");$(obj).removeClass("expanded")}}function window_open(url){if(!is_mobile()||arguments[3]===true){return env.open_window.apply(rcmail,arguments)}url=rcmail.add_url(url,"_framed",1);url=rcmail.add_url(url,"_extwin",1);var label,title="",props={cancel_button:"close",width:768,height:768},frame=$("<iframe>").attr({id:"windowframe",src:url});if(/_action=([a-z_]+)/.test(url)&&(label=rcmail.labels[RegExp.$1])){title=label}if(/_frame=1/.test(url)){props.dialogClass="no-titlebar"}rcmail.simple_dialog(frame,title,null,props);return true}function layout_metadata(){if(is_framed){var doc=$(parent.document.documentElement);return{mode:doc[0].className.match(/layout-([a-z]+)/)?RegExp.$1:mode,touch:doc.is(".touch")}}return{mode:mode,touch:touch}}function is_mobile(){var meta=layout_metadata();return meta.mode=="phone"||meta.mode=="small"}function is_touch(){var meta=layout_metadata();return meta.touch}}if(window.rcmail){rcmail.show_menu=function(prop,show,event){var name=typeof prop=="object"?prop.menu:prop,obj=$("#"+name);if(typeof prop=="string"){prop={menu:name}}return rcmail.triggerEvent(show===false?"menu-close":"menu-open",{name:name,obj:obj,props:prop,originalEvent:event})};rcmail.hide_menu=function(name,event){return rcmail.triggerEvent("menu-close",{name:name,props:{menu:name},originalEvent:event})}}else{var rcmail=parent.rcmail,rcube_webmail=parent.rcube_webmail,bw={}}var UI=new rcube_elastic_ui;if($&&$.datepicker){var __newInst=$.datepicker._newInst;$.extend($.datepicker,{_newInst:function(target,inline){var inst=__newInst.call(this,target,inline);if(!inst.inline){UI.datepicker_init(inst.dpDiv)}return inst}})}
